// nextflow.config

// Pipeline parameters
params {
    publish_dir_mode    = "copy"
    // Input/output
    samplesheet         = "${projectDir}/assets/samplesheet.csv"
    outdir              = "results"

    // Database paths
    taxdump             = ""
    sqlite              = ""
    rfam_db             = "${projectDir}/assets/rfam_db.conf"

    // Processing options
    max_runs            = 1
    max_orthodb_clusters = null
    order_runs_by_smallest = false
    sourmash            = false
    swissprot           = false

    // Validation
    validate_params     = true
    cleanup_workdir     = false
}

cleanup = params.cleanup_workdir

workDir = ""

includeConfig 'conf/base.config'
includeConfig 'conf/modules.config'

profiles {
    conda {
        conda.enabled = true
    }
    
    docker {
        docker.enabled = true
        conda.enabled = false
        docker.registry = "quay.io"
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.registry = "quay.io"
        singularity.cacheDir = ""
        conda.enabled = false
    }

    local {
        includeConfig 'conf/local.config'
    }
    test {
        includeConfig 'conf/test.config'
    }
}

// Process configuration
process {
// Set bash options
    shell = [
        "bash",
        "-C",         // No clobber - prevent output redirection from overwriting files.
        "-e",         // Exit if a tool returns a non-zero status/exit code
        "-u",         // Treat unset variables and parameters as an error
        "-o",         // Returns the status of the last command to exit..
        "pipefail"    //   ..with a non-zero status or zero if all successfully execute
    ]
    
    // Basic resource defaults
    cpus = 1
    memory = '4.GB'
    time = '2.h'
}

// Execution reports
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}
report {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_report.html"
    overwrite = true
}
trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
}
dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

// Pipeline manifest
manifest {
    name = 'Datascout'
    description =  "A pipeline for fetching protein and sequence data from multiple databases: ENA, UniProt, OrthoDB, and RFAM"
    version = '1.0.0'
    mainScript = 'main.nf'
    nextflowVersion = '>=23.04.0'
}

// nf-schema plugin for parameter validation
plugins {
    id 'nf-schema@2.1.0'
}